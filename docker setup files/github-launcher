#!/bin/bash
# Copyright (c) 2025-2026 Mik Gangal
# Licensed under CC BY-NC-SA 4.0 - https://creativecommons.org/licenses/by-nc-sa/4.0/

GITHUB_DIR="/GITHUB"

# ============================================
# Self-healing: Fix corrupted lazygit binary
# (Windows Docker builds can corrupt binaries)
# ============================================
check_and_fix_lazygit() {
    # Test if lazygit works
    if lazygit --version > /dev/null 2>&1; then
        return 0  # Binary works fine
    fi

    echo "lazygit binary corrupted (Windows Docker build issue)"
    echo "Downloading fresh copy..."

    # Get latest version
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" | grep -Po '"tag_name": "v\K[^"]*')
    if [ -z "$LAZYGIT_VERSION" ]; then
        echo "ERROR: Could not fetch lazygit version"
        return 1
    fi

    # Download and install
    curl -Lo /tmp/lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    if [ $? -ne 0 ]; then
        echo "ERROR: Download failed"
        return 1
    fi

    # Extract and install (overwrites corrupted binary)
    tar xf /tmp/lazygit.tar.gz -C /tmp lazygit
    install /tmp/lazygit /usr/local/bin
    rm -f /tmp/lazygit.tar.gz /tmp/lazygit

    # Verify fix
    if lazygit --version > /dev/null 2>&1; then
        echo "lazygit v${LAZYGIT_VERSION} installed successfully"
        return 0
    else
        echo "ERROR: lazygit still not working after reinstall"
        return 1
    fi
}

# Run self-healing check
check_and_fix_lazygit || {
    echo "Failed to fix lazygit. Press Enter to exit..."
    read
    exit 1
}

# Check if logged into GitHub
if ! gh auth status &>/dev/null; then
    echo "Not logged into GitHub. Starting authentication..."
    gh auth login --web -h github.com

    if ! gh auth status &>/dev/null; then
        echo "Authentication failed."
        read -p "Press Enter to exit..."
        exit 1
    fi
    echo "Authentication successful!"

    # Auto-configure git with GitHub username and noreply email
    username=$(gh api user -q '.login')
    if [ -n "$username" ]; then
        git config --global user.name "$username"
        git config --global user.email "${username}@users.noreply.github.com"
        echo "Git configured: $username <${username}@users.noreply.github.com>"
    fi
    echo ""
fi

# Ensure GITHUB_DIR exists
mkdir -p "$GITHUB_DIR"

# Get list of repos
echo "Fetching your repositories..."
repos=$(gh repo list --limit 50 --json nameWithOwner -q '.[].nameWithOwner')

if [ -z "$repos" ]; then
    echo "No repositories found."
    read -p "Press Enter to exit..."
    exit 1
fi

echo ""
echo "Your repositories:"
echo "=================="
i=1
while IFS= read -r repo; do
    repo_name=$(basename "$repo")
    if [ -d "$GITHUB_DIR/$repo_name/.git" ]; then
        echo "$i) $repo [CLONED]"
    else
        echo "$i) $repo"
    fi
    ((i++))
done <<< "$repos"
echo ""

read -p "Enter the number of the repo to open (or 'q' to quit): " choice

if [ "$choice" = "q" ]; then
    exit 0
fi

selected=$(echo "$repos" | sed -n "${choice}p")

if [ -z "$selected" ]; then
    echo "Invalid selection."
    read -p "Press Enter to exit..."
    exit 1
fi

repo_name=$(basename "$selected")

# Check if already cloned
if [ -d "$GITHUB_DIR/$repo_name/.git" ]; then
    echo "Opening $repo_name..."
    cd "$GITHUB_DIR/$repo_name"
    exec lazygit
else
    echo "Cloning $selected..."
    cd "$GITHUB_DIR"
    gh repo clone "$selected"

    if [ -d "$GITHUB_DIR/$repo_name/.git" ]; then
        cd "$GITHUB_DIR/$repo_name"
        exec lazygit
    else
        echo "Clone failed."
        read -p "Press Enter to exit..."
        exit 1
    fi
fi
